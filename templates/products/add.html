
{% extends "base.html" %}

{% block title %}Tambah Produk{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Tambah Produk Baru</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('products') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Kembali
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Informasi Produk</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <!-- Basic Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="product_id" class="form-label">ID Produk</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="product_id" name="product_id" 
                                       value="{{ generated_id }}" maxlength="50" 
                                       pattern="[A-Za-z0-9_-]+" title="Maksimal 50 karakter: huruf, angka, underscore, dash"
                                       oninput="validateProductId()">
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleManualInput()" id="toggleBtn">
                                    <i class="fas fa-edit" id="toggleIcon"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="generateNewId()">
                                    <i class="fas fa-refresh"></i>
                                </button>
                            </div>
                            <small class="text-muted" id="productIdHelp">ID unik untuk produk (maksimal 50 karakter) - Klik ikon pensil untuk input manual</small>
                            <div class="invalid-feedback" id="productIdError"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="name" class="form-label">Nama Produk *</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="category" class="form-label">Kategori</label>
                            <select class="form-select" id="category" name="category">
                                <option value="">Pilih Kategori</option>
                                <option value="Elektronik">Elektronik</option>
                                <option value="Pakaian">Pakaian</option>
                                <option value="Makanan">Makanan</option>
                                <option value="Minuman">Minuman</option>
                                <option value="Kesehatan">Kesehatan</option>
                                <option value="Kecantikan">Kecantikan</option>
                                <option value="Rumah Tangga">Rumah Tangga</option>
                                <option value="Olahraga">Olahraga</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="brand" class="form-label">Merek</label>
                            <input type="text" class="form-control" id="brand" name="brand">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Deskripsi</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="supplier" class="form-label">Supplier</label>
                            <input type="text" class="form-control" id="supplier" name="supplier">
                        </div>
                        <div class="col-md-6">
                            <label for="unit" class="form-label">Satuan</label>
                            <select class="form-select" id="unit" name="unit">
                                <option value="pcs">Pcs (Pieces)</option>
                                <option value="kg">Kg (Kilogram)</option>
                                <option value="gram">Gram</option>
                                <option value="liter">Liter</option>
                                <option value="ml">Ml (Mililiter)</option>
                                <option value="meter">Meter</option>
                                <option value="cm">Cm (Centimeter)</option>
                                <option value="box">Box</option>
                                <option value="pack">Pack</option>
                                <option value="dozen">Dozen</option>
                            </select>
                        </div>
                    </div>

                    <!-- Pricing Information -->
                    <h6 class="text-primary mt-4 mb-3"><i class="fas fa-money-bill-wave me-2"></i>Informasi Harga</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="purchase_price" class="form-label">Harga Beli (HB) *</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input type="number" class="form-control" id="purchase_price" name="purchase_price" 
                                       min="0" step="0.01" required oninput="calculateProfit()">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="selling_price" class="form-label">Harga Jual (HJ) *</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input type="number" class="form-control" id="selling_price" name="selling_price" 
                                       min="0" step="0.01" required oninput="calculateProfit()">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Profit per Unit</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input type="text" class="form-control" id="profit_per_unit" readonly>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Margin (%)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="margin_percent" readonly>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="expiry_date" class="form-label">Tanggal Kedaluwarsa</label>
                            <input type="date" class="form-control" id="expiry_date" name="expiry_date">
                        </div>
                    </div>

                    <!-- Stock Information -->
                    <h6 class="text-success mt-4 mb-3"><i class="fas fa-boxes me-2"></i>Informasi Stok</h6>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="initial_stock" class="form-label">Stok Awal (SA) *</label>
                            <input type="number" class="form-control" id="initial_stock" name="initial_stock" 
                                   min="0" required oninput="calculateFinalStock()">
                        </div>
                        <div class="col-md-3">
                            <label for="additional_stock" class="form-label">Pembelian</label>
                            <input type="number" class="form-control" id="additional_stock" name="additional_stock" 
                                   min="0" value="0" oninput="calculateFinalStock()">
                        </div>
                        <div class="col-md-3">
                            <label for="current_stock" class="form-label">Stok Akhir (SK) *</label>
                            <input type="number" class="form-control" id="current_stock" name="current_stock" 
                                   min="0" required oninput="calculateSoldItems()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Barang Terjual (BT)</label>
                            <input type="text" class="form-control" id="items_sold" readonly>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="minimum_stock" class="form-label">Minimum Stok</label>
                            <input type="number" class="form-control" id="minimum_stock" name="minimum_stock" 
                                   min="0" value="5">
                        </div>
                        <div class="col-md-4">
                            <label for="maximum_stock" class="form-label">Maximum Stok</label>
                            <input type="number" class="form-control" id="maximum_stock" name="maximum_stock" 
                                   min="0" value="1000">
                        </div>
                        <div class="col-md-4">
                            <label for="weight" class="form-label">Berat (kg)</label>
                            <input type="number" class="form-control" id="weight" name="weight" 
                                   min="0" step="0.01">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="dimensions" class="form-label">Dimensi (P x L x T)</label>
                        <input type="text" class="form-control" id="dimensions" name="dimensions" 
                               placeholder="contoh: 10 x 5 x 3 cm">
                    </div>

                    <!-- Profit Calculation Display -->
                    <div class="card bg-light mt-4">
                        <div class="card-body">
                            <h6 class="text-info mb-3"><i class="fas fa-calculator me-2"></i>Kalkulasi Profit</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">Pendapatan (R)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rp</span>
                                        <input type="text" class="form-control" id="total_revenue" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Modal (C)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rp</span>
                                        <input type="text" class="form-control" id="total_cost" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Total Profit</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rp</span>
                                        <input type="text" class="form-control" id="total_profit" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Margin Total</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="total_margin" readonly>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="button" class="btn btn-secondary me-md-2" onclick="resetForm()">
                            <i class="fas fa-undo me-2"></i>Reset
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Simpan Produk
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Informasi Formula</h6>
            </div>
            <div class="card-body">
                <h6 class="text-primary">Formula Bisnis</h6>
                <ul class="list-unstyled">
                    <li><strong>BT</strong> = SA + Pembelian - SK</li>
                    <li><strong>R</strong> = HJ × BT</li>
                    <li><strong>C</strong> = HB × BT</li>
                    <li><strong>Profit</strong> = R - C</li>
                    <li><strong>Margin</strong> = (Profit / R) × 100%</li>
                </ul>

                <h6 class="text-success mt-4">Keterangan</h6>
                <ul class="list-unstyled small">
                    <li><strong>HB</strong> = Harga Beli</li>
                    <li><strong>HJ</strong> = Harga Jual</li>
                    <li><strong>SA</strong> = Stok Awal</li>
                    <li><strong>SK</strong> = Stok Akhir</li>
                    <li><strong>BT</strong> = Barang Terjual</li>
                    <li><strong>R</strong> = Revenue (Pendapatan)</li>
                    <li><strong>C</strong> = Cost (Modal)</li>
                </ul>

                <div class="alert alert-info mt-3">
                    <small>
                        <i class="fas fa-lightbulb me-2"></i>
                        Sistem akan otomatis menghitung profit berdasarkan formula di atas
                    </small>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <small>
                        <i class="fas fa-id-card me-2"></i>
                        <strong>ID Produk:</strong> Maksimum 100 produk (PRD001-PRD100)
                        <br>• Mode Auto: Sistem otomatis memilih ID berikutnya
                        <br>• Mode Manual: Input manual PRD001-PRD100
                    </small>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="fas fa-barcode me-2"></i>Codes Preview</h6>
            </div>
            <div class="card-body text-center">
                <p class="text-muted">Barcode dan QR code akan dibuat otomatis setelah produk disimpan</p>
            </div>
        </div>
    </div>
</div>

<script>
let isManualMode = false;

function generateNewId() {
    fetch('/api/generate_product_id')
        .then(response => response.json())
        .then(data => {
            if (data.product_id) {
                document.getElementById('product_id').value = data.product_id;
                document.getElementById('productIdError').textContent = '';
                document.getElementById('product_id').classList.remove('is-invalid');
            } else {
                alert('Semua ID produk (PRD001-PRD100) sudah terpakai!');
            }
        })
        .catch(error => {
            console.error('Error generating product ID:', error);
            alert('Error generating product ID');
        });
}

function toggleManualInput() {
    const productIdField = document.getElementById('product_id');
    const toggleBtn = document.getElementById('toggleBtn');
    const toggleIcon = document.getElementById('toggleIcon');
    const helpText = document.getElementById('productIdHelp');
    
    isManualMode = !isManualMode;
    
    if (isManualMode) {
        productIdField.removeAttribute('readonly');
        productIdField.focus();
        toggleIcon.className = 'fas fa-lock';
        helpText.textContent = 'Mode manual aktif - Masukkan ID (maksimal 50 karakter)';
        helpText.className = 'text-warning';
    } else {
        productIdField.setAttribute('readonly', true);
        toggleIcon.className = 'fas fa-edit';
        helpText.textContent = 'ID unik untuk produk (maksimal 50 karakter) - Klik ikon pensil untuk input manual';
        helpText.className = 'text-muted';
        generateNewId(); // Auto-generate when switching back to auto mode
    }
}

function validateProductId() {
    const productIdField = document.getElementById('product_id');
    const errorDiv = document.getElementById('productIdError');
    const productId = productIdField.value.trim();
    
    if (!isManualMode) return; // Skip validation in auto mode
    
    // Check length
    if (productId.length > 50) {
        productIdField.classList.add('is-invalid');
        errorDiv.textContent = 'Maksimal 50 karakter';
        return;
    }
    
    if (productId.length < 1) {
        productIdField.classList.add('is-invalid');
        errorDiv.textContent = 'ID produk tidak boleh kosong';
        return;
    }
    
    // Check format - only letters, numbers, underscore, dash
    const formatRegex = /^[A-Za-z0-9_-]+$/;
    if (!formatRegex.test(productId)) {
        productIdField.classList.add('is-invalid');
        errorDiv.textContent = 'Hanya huruf, angka, underscore (_) dan dash (-)';
        return;
    }
    
    // Check availability
    fetch(`/api/check_product_id/${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                productIdField.classList.add('is-invalid');
                errorDiv.textContent = 'ID produk sudah ada';
            } else {
                productIdField.classList.remove('is-invalid');
                errorDiv.textContent = '';
            }
        })
        .catch(error => {
            console.error('Error checking product ID:', error);
        });
}

function calculateProfit() {
    const purchasePrice = parseFloat(document.getElementById('purchase_price').value) || 0;
    const sellingPrice = parseFloat(document.getElementById('selling_price').value) || 0;
    
    const profitPerUnit = sellingPrice - purchasePrice;
    const marginPercent = sellingPrice > 0 ? ((profitPerUnit / sellingPrice) * 100) : 0;
    
    document.getElementById('profit_per_unit').value = formatCurrency(profitPerUnit);
    document.getElementById('margin_percent').value = marginPercent.toFixed(2);
    
    calculateTotalProfit();
}

function calculateFinalStock() {
    const initialStock = parseInt(document.getElementById('initial_stock').value) || 0;
    const additionalStock = parseInt(document.getElementById('additional_stock').value) || 0;
    
    // Auto-set current stock to initial + additional if not manually changed
    const currentStockField = document.getElementById('current_stock');
    if (!currentStockField.dataset.manuallySet) {
        currentStockField.value = initialStock + additionalStock;
    }
    
    calculateSoldItems();
}

function calculateSoldItems() {
    const initialStock = parseInt(document.getElementById('initial_stock').value) || 0;
    const additionalStock = parseInt(document.getElementById('additional_stock').value) || 0;
    const currentStock = parseInt(document.getElementById('current_stock').value) || 0;
    
    const itemsSold = Math.max(0, initialStock + additionalStock - currentStock);
    document.getElementById('items_sold').value = itemsSold;
    
    calculateTotalProfit();
}

function calculateTotalProfit() {
    const purchasePrice = parseFloat(document.getElementById('purchase_price').value) || 0;
    const sellingPrice = parseFloat(document.getElementById('selling_price').value) || 0;
    const itemsSold = parseInt(document.getElementById('items_sold').value) || 0;
    
    const totalRevenue = sellingPrice * itemsSold;
    const totalCost = purchasePrice * itemsSold;
    const totalProfit = totalRevenue - totalCost;
    const totalMargin = totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100) : 0;
    
    document.getElementById('total_revenue').value = formatCurrency(totalRevenue);
    document.getElementById('total_cost').value = formatCurrency(totalCost);
    document.getElementById('total_profit').value = formatCurrency(totalProfit);
    document.getElementById('total_margin').value = totalMargin.toFixed(2);
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('id-ID').format(Math.round(amount));
}

function resetForm() {
    if (confirm('Apakah Anda yakin ingin mereset form?')) {
        document.querySelector('form').reset();
        generateNewId();
    }
}

// Mark current stock as manually set when user types in it
document.getElementById('current_stock').addEventListener('input', function() {
    this.dataset.manuallySet = 'true';
    calculateSoldItems();
});

// Initialize calculations
document.addEventListener('DOMContentLoaded', function() {
    calculateProfit();
    calculateSoldItems();
});
</script>
{% endblock %}
