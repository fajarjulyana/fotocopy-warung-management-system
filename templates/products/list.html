
{% extends "base.html" %}

{% block title %}Daftar Produk{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Manajemen Produk</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-filter me-2"></i>Filter
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="?filter=low_stock">Stok Rendah</a></li>
                <li><a class="dropdown-item" href="?filter=expired">Kadaluwarsa</a></li>
                <li><a class="dropdown-item" href="?filter=inactive">Tidak Aktif</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('products') }}">Semua Produk</a></li>
            </ul>
        </div>
        <a href="{{ url_for('add_product') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Tambah Produk
        </a>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex">
                    <div class="flex-grow-1">
                        <h6 class="card-title">Total Produk</h6>
                        <h3>{{ products|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-boxes fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex">
                    <div class="flex-grow-1">
                        <h6 class="card-title">Produk Aktif</h6>
                        <h3>{{ products|selectattr('is_active')|list|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex">
                    <div class="flex-grow-1">
                        <h6 class="card-title">Stok Rendah</h6>
                        <h3>
                            {% set low_stock_count = [] %}
                            {% for product in products %}
                                {% if (product.current_stock or 0) <= (product.minimum_stock or 5) %}
                                    {% set _ = low_stock_count.append(1) %}
                                {% endif %}
                            {% endfor %}
                            {{ low_stock_count|length }}
                        </h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex">
                    <div class="flex-grow-1">
                        <h6 class="card-title">Total Revenue</h6>
                        <h3>{{ format_currency((products|sum(attribute='total_revenue') if products else 0) or 0) }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if products %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID/Brand</th>
                        <th>Produk</th>
                        <th>Kategori</th>
                        <th>Harga</th>
                        <th>Stok</th>
                        <th>Penjualan</th>
                        <th>Status</th>
                        <th>Codes</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr class="{% if not product.is_active %}table-secondary{% elif (product.current_stock or 0) <= (product.minimum_stock or 5) %}table-warning{% endif %}">
                        <td>
                            <code>{{ product.id }}</code>
                            {% if product.brand %}
                                <br><small class="text-muted">{{ product.brand }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <strong>{{ product.name }}</strong>
                                {% if product.description %}
                                    <br><small class="text-muted">{{ product.description[:50] }}{% if product.description|length > 50 %}...{% endif %}</small>
                                {% endif %}
                                {% if product.unit and product.unit != 'pcs' %}
                                    <br><span class="badge bg-secondary">{{ product.unit }}</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>{{ product.category or 'Lainnya' }}</td>
                        <td>
                            <div>
                                <strong>{{ format_currency(product.purchase_price or 0) }}</strong>
                                <br><small class="text-muted">Beli</small>
                            </div>
                            <div class="mt-1">
                                <strong class="text-success">{{ format_currency(product.selling_price or 0) }}</strong>
                                <br><small class="text-muted">Jual</small>
                            </div>
                        </td>
                        <td>
                            <div>
                                <strong class="{% if (product.current_stock or 0) <= (product.minimum_stock or 5) %}text-danger{% elif (product.current_stock or 0) <= ((product.minimum_stock or 5) * 2) %}text-warning{% else %}text-success{% endif %}">
                                    {{ product.current_stock or 0 }}
                                </strong>
                                <br><small class="text-muted">Min: {{ product.minimum_stock or 5 }}</small>
                                <br><small class="text-muted">Max: {{ product.maximum_stock or 1000 }}</small>
                            </div>
                        </td>
                        <td>
                            {% set items_sold = (product.initial_stock or 0) - (product.current_stock or 0) %}
                            <div>
                                <strong>{{ product.total_sold or items_sold }} unit</strong>
                                <br><small class="text-success">{{ format_currency(product.total_revenue or 0) }}</small>
                                <br><small class="text-{% if (product.profit or 0) > 0 %}success{% else %}muted{% endif %}">
                                    Profit: {{ format_currency(product.profit or 0) }}
                                </small>
                            </div>
                        </td>
                        <td>
                            <div>
                                {% if product.is_active %}
                                    <span class="badge bg-success">Aktif</span>
                                {% else %}
                                    <span class="badge bg-secondary">Tidak Aktif</span>
                                {% endif %}

                                {% if product.expiry_date %}
                                    {% set days_to_expiry = (product.expiry_date - datetime.now().date()).days %}
                                    {% if days_to_expiry < 0 %}
                                        <br><span class="badge bg-danger">Kadaluwarsa</span>
                                    {% elif days_to_expiry < 30 %}
                                        <br><span class="badge bg-warning">{{ days_to_expiry }} hari lagi</span>
                                    {% endif %}
                                {% endif %}

                                {% if (product.current_stock or 0) <= (product.minimum_stock or 5) %}
                                    <br><span class="badge bg-danger">Stok Rendah</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="showBarcode('{{ product.barcode or product.id }}')" title="Barcode">
                                    <i class="fas fa-barcode"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="showQRCode('{{ product.qr_code or product.id }}')" title="QR Code">
                                    <i class="fas fa-qrcode"></i>
                                </button>
                                <a href="{{ url_for('print_product_codes', product_id=product.id) }}" class="btn btn-outline-success" title="Print Codes" target="_blank">
                                    <i class="fas fa-print"></i>
                                </a>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="viewProduct('{{ product.id }}')" title="Detail">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-outline-warning" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-outline-{% if product.is_active %}secondary{% else %}success{% endif %}" onclick="toggleProduct('{{ product.id }}')" title="{% if product.is_active %}Nonaktifkan{% else %}Aktifkan{% endif %}">
                                    <i class="fas fa-{% if product.is_active %}ban{% else %}check{% endif %}"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteProduct('{{ product.id }}')" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-box fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Belum ada produk</h5>
            <p class="text-muted">Tambahkan produk pertama Anda</p>
            <a href="{{ url_for('add_product') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Tambah Produk
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal untuk menampilkan barcode/QR code -->
<div class="modal fade" id="codeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="codeModalTitle">Code Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="codeContainer"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<!-- Product Detail Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detail Produk</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="productDetailContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<script>
function showBarcode(code) {
    document.getElementById('codeModalTitle').textContent = 'Barcode Preview';
    document.getElementById('codeContainer').innerHTML = `
        <img src="/api/generate_barcode/${code}" class="img-fluid" alt="Barcode" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmZmIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkJhcmNvZGUgTi9BPC90ZXh0Pgo8L3N2Zz4='">
        <p class="mt-2"><code>${code}</code></p>
    `;
    new bootstrap.Modal(document.getElementById('codeModal')).show();
}

function showQRCode(code) {
    document.getElementById('codeModalTitle').textContent = 'QR Code Preview';
    document.getElementById('codeContainer').innerHTML = `
        <img src="/api/generate_qrcode/${code}" class="img-fluid" alt="QR Code" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmZmIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPVFSIE4vQTwvdGV4dD4KPC9zdmc+'">
        <p class="mt-2"><code>${code}</code></p>
    `;
    new bootstrap.Modal(document.getElementById('codeModal')).show();
}

function viewProduct(productId) {
    fetch(`/api/product/${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('productDetailContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Informasi Produk</h6>
                            <table class="table table-sm">
                                <tr><td>ID:</td><td>${data.product.id}</td></tr>
                                <tr><td>Nama:</td><td>${data.product.name}</td></tr>
                                <tr><td>Kategori:</td><td>${data.product.category || 'Lainnya'}</td></tr>
                                <tr><td>Brand:</td><td>${data.product.brand || '-'}</td></tr>
                                <tr><td>Unit:</td><td>${data.product.unit || 'pcs'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Harga & Stok</h6>
                            <table class="table table-sm">
                                <tr><td>Harga Beli:</td><td>Rp ${(data.product.purchase_price || 0).toLocaleString('id-ID')}</td></tr>
                                <tr><td>Harga Jual:</td><td>Rp ${(data.product.selling_price || 0).toLocaleString('id-ID')}</td></tr>
                                <tr><td>Stok Saat Ini:</td><td>${data.product.current_stock || 0}</td></tr>
                                <tr><td>Profit:</td><td>Rp ${(data.product.profit || 0).toLocaleString('id-ID')}</td></tr>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('productDetailContent').innerHTML = '<div class="alert alert-danger">Error loading product details</div>';
            }
        })
        .catch(error => {
            document.getElementById('productDetailContent').innerHTML = '<div class="alert alert-danger">Error loading product details</div>';
        });
    
    new bootstrap.Modal(document.getElementById('productDetailModal')).show();
}

function toggleProduct(productId) {
    if (confirm('Apakah Anda yakin ingin mengubah status produk ini?')) {
        window.location.href = `/products/${productId}/toggle`;
    }
}

function deleteProduct(productId) {
    if (confirm('Apakah Anda yakin ingin menghapus produk ini? Tindakan ini tidak dapat dibatalkan!')) {
        window.location.href = `/products/${productId}/delete`;
    }
}
</script>
{% endblock %}
