
{% extends "base.html" %}

{% block title %}Sistem Kasir/POS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-cash-register me-2"></i>
        Sistem Kasir/POS
    </h1>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Scan/Cari Produk</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="barcode-input" class="form-label">Scan Barcode/Kode Produk</label>
                        <input type="text" class="form-control" id="barcode-input" placeholder="Scan barcode atau ketik kode produk">
                    </div>
                    <div class="col-md-6">
                        <label for="search-input" class="form-label">Cari Berdasarkan ID/Nama</label>
                        <input type="text" class="form-control" id="search-input" placeholder="Ketik ID atau nama produk">
                        <div id="search-results" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Keranjang Belanja</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="cart-table">
                        <thead>
                            <tr>
                                <th>Produk</th>
                                <th>Harga</th>
                                <th>Jumlah</th>
                                <th>Subtotal</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="cart-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card sticky-top">
            <div class="card-header">
                <h5 class="mb-0">Kasir</h5>
            </div>
            <div class="card-body">
                <!-- Receipt Preview -->
                <div class="card mb-3" style="background-color: #1a1a1a; max-height: 300px; overflow-y: auto;">
                    <div class="card-body p-2" id="receipt-preview" style="font-family: 'Courier New', monospace; font-size: 11px; color: #00ff00;">
                        <div class="text-center">
                            <div style="color: #ffffff;">==========================================</div>
                            <div style="color: #00ff00; font-weight: bold;">PREVIEW STRUK</div>
                            <div style="color: #ffffff;">==========================================</div>
                            <div id="preview-content">
                                <div class="text-center mt-3" style="color: #666;">
                                    <i class="fas fa-shopping-cart"></i><br>
                                    Keranjang kosong
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Section -->
                <div class="text-center mb-3">
                    <h3 class="text-primary" id="total-amount">Rp 0</h3>
                </div>
                
                <div class="mb-3">
                    <label for="payment-amount" class="form-label">Jumlah Bayar</label>
                    <input type="number" class="form-control" id="payment-amount" placeholder="0" min="0">
                    <div class="mt-2">
                        <small class="text-muted">Quick Pay:</small><br>
                        <div class="btn-group-sm mt-1" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm me-1" onclick="quickPay(50000)">50K</button>
                            <button type="button" class="btn btn-outline-primary btn-sm me-1" onclick="quickPay(100000)">100K</button>
                            <button type="button" class="btn btn-outline-primary btn-sm me-1" onclick="quickPay(200000)">200K</button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="exactPay()">Pas</button>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Kembalian: <span id="change-amount">Rp 0</span></strong>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-lg" id="process-sale" disabled>
                        <i class="fas fa-money-bill me-2"></i>
                        Proses Pembayaran
                    </button>
                    <button class="btn btn-outline-secondary" id="clear-cart">
                        <i class="fas fa-trash me-2"></i>
                        Kosongkan Keranjang
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" id="receipt-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transaksi Berhasil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                <h4>Pembayaran Berhasil!</h4>
                <p>Transaksi ID: <span id="transaction-id"></span></p>
                <p>Total: <span id="receipt-total"></span></p>
                <p>Kembalian: <span id="receipt-change"></span></p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" id="print-receipt">
                    <i class="fas fa-print me-2"></i>
                    Cetak Struk PDF
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Tutup
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let cart = [];
let items = {{ items|tojson }};

// Convert items to proper format if needed
items = items.map(item => ({
    kode: item.id || item.kode,
    nama: item.name || item.nama,
    harga_jual: item.selling_price || item.harga_jual,
    stok_akhir: item.current_stock || item.stok_akhir,
    barcode: item.barcode || item.id || item.kode
}));

// Real cashier barcode scanner functionality
document.getElementById('barcode-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const barcode = this.value.trim().toUpperCase();
        if (barcode) {
            searchByBarcode(barcode);
            
            // Visual feedback - always flash to show scan was registered
            this.style.borderColor = '#28a745';
            this.style.boxShadow = '0 0 8px rgba(40, 167, 69, 0.6)';
            this.style.backgroundColor = '#d4edda';
            
            setTimeout(() => {
                this.style.borderColor = '';
                this.style.boxShadow = '';
                this.style.backgroundColor = '';
            }, 200);
            
            this.value = '';
        }
    }
});

// Auto-focus barcode input when page loads (like real cashier)
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('barcode-input').focus();
});

// Notification system for real cashier feedback
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existing = document.querySelectorAll('.pos-notification');
    existing.forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show pos-notification`;
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
    
    notification.innerHTML = `
        <strong>${type === 'success' ? '✓' : type === 'warning' ? '⚠' : 'ℹ'}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Search functionality
document.getElementById('search-input').addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    const resultsDiv = document.getElementById('search-results');
    
    if (query.length < 2) {
        resultsDiv.innerHTML = '';
        return;
    }
    
    const results = items.filter(item => 
        (item.kode && item.kode.toLowerCase().includes(query)) || 
        (item.nama && item.nama.toLowerCase().includes(query)) ||
        (item.barcode && item.barcode.toLowerCase().includes(query))
    ).slice(0, 5);
    
    resultsDiv.innerHTML = results.map(item => `
        <div class="border rounded p-2 mb-2 search-result" style="cursor: pointer;" onclick="addToCart('${item.kode}')">
            <strong>${item.nama}</strong><br>
            <small>Kode: ${item.kode} | Harga: ${formatCurrency(item.harga_jual)} | Stok: ${item.stok_akhir}</small>
        </div>
    `).join('');
});

function searchByBarcode(barcode) {
    // Real cashier search: try exact match first, then partial
    let item = items.find(i => 
        i.kode === barcode || 
        (i.barcode && i.barcode === barcode) ||
        i.kode.toUpperCase() === barcode ||
        (i.barcode && i.barcode.toUpperCase() === barcode)
    );
    
    // If no exact match, try partial search on product code
    if (!item) {
        item = items.find(i => 
            i.kode.toUpperCase().includes(barcode) && 
            i.stok_akhir > 0
        );
    }
    
    if (item) {
        addToCart(item.kode);
    } else {
        // Real cashier behavior: show item not found but keep working
        showNotification(`Kode "${barcode}" tidak ditemukan`, 'warning');
        
        // Keep focus on barcode input for next scan
        setTimeout(() => {
            document.getElementById('barcode-input').focus();
        }, 100);
    }
}

function addToCart(itemKode) {
    const item = items.find(i => i.kode === itemKode);
    if (!item) {
        showNotification(`Produk dengan kode "${itemKode}" tidak ditemukan`, 'warning');
        return;
    }
    
    if (item.stok_akhir <= 0) {
        showNotification(`Stok habis untuk produk "${item.nama}"`, 'warning');
        return;
    }
    
    // Check if item already exists in cart - REAL CASHIER BEHAVIOR
    const existingItem = cart.find(c => c.kode === itemKode);
    if (existingItem) {
        // Item already in cart, increase quantity (like real cashier)
        if (existingItem.quantity >= item.stok_akhir) {
            showNotification(`Stok tidak mencukupi untuk "${item.nama}". Stok tersedia: ${item.stok_akhir}`, 'warning');
            return;
        }
        existingItem.quantity++;
        showNotification(`+1 ${item.nama} (Total: ${existingItem.quantity})`, 'success');
    } else {
        // New item, add to cart
        cart.push({
            kode: itemKode,
            nama: item.nama,
            barcode: item.barcode || item.kode,
            harga_jual: item.harga_jual,
            quantity: 1,
            max_stock: item.stok_akhir
        });
        showNotification(`${item.nama} ditambahkan ke keranjang`, 'success');
    }
    
    updateCartDisplay();
    document.getElementById('search-input').value = '';
    document.getElementById('search-results').innerHTML = '';
    
    // Auto-focus back to barcode input for continuous scanning
    document.getElementById('barcode-input').focus();
}

function removeFromCart(itemId) {
    cart = cart.filter(item => item.id !== itemId);
    updateCartDisplay();
}

function updateQuantity(itemKode, newQuantity) {
    const cartItem = cart.find(item => item.kode === itemKode);
    if (cartItem) {
        if (newQuantity <= 0) {
            removeFromCart(itemKode);
        } else if (newQuantity <= cartItem.max_stock) {
            cartItem.quantity = newQuantity;
            updateCartDisplay();
        }
        // Silent fail if quantity exceeds stock
    }
}

function removeFromCart(itemKode) {
    cart = cart.filter(item => item.kode !== itemKode);
    updateCartDisplay();
}

function updateCartDisplay() {
    const tbody = document.getElementById('cart-body');
    
    if (cart.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Keranjang kosong</td></tr>';
    } else {
        tbody.innerHTML = cart.map(item => {
            const subtotal = item.harga_jual * item.quantity;
            return `
                <tr>
                    <td>
                        <strong>${item.nama}</strong><br>
                        <small class="text-muted">Kode: ${item.kode}</small>
                    </td>
                    <td>${formatCurrency(item.harga_jual)}</td>
                    <td>
                        <div class="input-group input-group-sm" style="width: 120px;">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity('${item.kode}', ${item.quantity - 1})">-</button>
                            <input type="number" class="form-control text-center" value="${item.quantity}" 
                                   onchange="updateQuantity('${item.kode}', parseInt(this.value))" min="1" max="${item.max_stock}">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity('${item.kode}', ${item.quantity + 1})">+</button>
                        </div>
                    </td>
                    <td><strong>${formatCurrency(subtotal)}</strong></td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart('${item.kode}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    updateTotals();
    updateReceiptPreview();
}

function updateReceiptPreview() {
    const previewContent = document.getElementById('preview-content');
    const now = new Date();
    
    if (cart.length === 0) {
        previewContent.innerHTML = `
            <div class="text-center mt-3" style="color: #666;">
                <i class="fas fa-shopping-cart"></i><br>
                Keranjang kosong
            </div>
        `;
        return;
    }
    
    const total = cart.reduce((sum, item) => sum + (item.selling_price * item.quantity), 0);
    
    let receiptHTML = `
        <div style="color: #00ff00; font-weight: bold;">FAJAR MANDIRI FOTOCOPY</div>
        <div style="color: #ffffff; font-size: 8px;">KP Jl. Pasir Wangi, RT.01/RW.11, Gudangkahuripan</div>
        <div style="color: #ffffff; font-size: 8px;">Kec. Lembang, Kab. Bandung Barat, Jawa Barat 40391</div>
        <div style="color: #ffffff; font-size: 9px;">Telp: (+62) 81804411937</div>
        <div style="color: #ffffff;">==========================================</div>
        <div style="color: #00ff00;">STRUK BELANJA</div>
        <div style="color: #ffffff;">==========================================</div>
        <div style="color: #ffffff; font-size: 9px;">No.Ref   : ${String(Math.floor(Math.random() * 1000000)).padStart(6, '0')}</div>
        <div style="color: #ffffff; font-size: 9px;">Tanggal  : ${now.toLocaleDateString('id-ID')}</div>
        <div style="color: #ffffff; font-size: 9px;">Waktu    : ${now.toLocaleTimeString('id-ID')}</div>
        <div style="color: #ffffff; font-size: 9px;">Kasir    : KASIR01</div>
        <div style="color: #ffffff;">------------------------------------------</div>
    `;
    
    cart.forEach((item, index) => {
        const subtotal = item.harga_jual * item.quantity;
        receiptHTML += `
            <div style="color: #ffffff; font-size: 9px;">${index + 1}. ${item.nama.substring(0, 25)}</div>
            <div style="color: #ffffff; font-size: 9px;">    ${item.quantity} x ${formatCurrency(item.harga_jual).replace('Rp ', '')} = ${formatCurrency(subtotal).replace('Rp ', '')}</div>
        `;
    });
    
    receiptHTML += `
        <div style="color: #ffffff;">------------------------------------------</div>
        <div style="color: #00ff00; font-weight: bold;">TOTAL: ${formatCurrency(total)}</div>
        <div style="color: #ffffff;">==========================================</div>
        <div style="color: #00ff00;">*** TERIMA KASIH ***</div>
        <div style="color: #ffffff; font-size: 9px;">SELAMAT BERBELANJA KEMBALI</div>
        <div style="color: #ffffff; font-size: 9px;">Barang yang sudah dibeli</div>
        <div style="color: #ffffff; font-size: 9px;">tidak dapat dikembalikan</div>
        <div style="color: #ffffff; font-size: 9px;">kecuali ada kesepakatan</div>
    `;
    
    previewContent.innerHTML = receiptHTML;
}

function updateTotals() {
    const total = cart.reduce((sum, item) => sum + (item.harga_jual * item.quantity), 0);
    document.getElementById('total-amount').textContent = formatCurrency(total);
    
    const paymentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
    const change = Math.max(0, paymentAmount - total);
    document.getElementById('change-amount').textContent = formatCurrency(change);
    
    const processButton = document.getElementById('process-sale');
    processButton.disabled = cart.length === 0 || paymentAmount < total;
}

document.getElementById('payment-amount').addEventListener('input', updateTotals);
document.getElementById('clear-cart').addEventListener('click', function() {
    if (confirm('Kosongkan semua item di keranjang?')) {
        cart = [];
        updateCartDisplay();
    }
});

document.getElementById('process-sale').addEventListener('click', function() {
    const total = cart.reduce((sum, item) => sum + (item.harga_jual * item.quantity), 0);
    const paymentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
    
    if (paymentAmount < total) {
        showNotification('Jumlah pembayaran kurang!', 'error');
        document.getElementById('payment-amount').focus();
        return;
    }
    
    // Show processing indicator
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Memproses...';
    
    const transactionData = {
        items: cart,
        payment_amount: paymentAmount
    };
    
    fetch('/cashier/process_sale', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(transactionData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Play success sound (if available)
            try {
                new Audio('data:audio/wav;base64,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').play();
            } catch(e) {}
            
            showNotification('Transaksi berhasil!', 'success');
            
            document.getElementById('transaction-id').textContent = data.transaction_id;
            document.getElementById('receipt-total').textContent = formatCurrency(data.total);
            document.getElementById('receipt-change').textContent = formatCurrency(data.change);
            
            // Show receipt modal
            const receiptModal = new bootstrap.Modal(document.getElementById('receipt-modal'));
            receiptModal.show();
            
            // Set up print button
            document.getElementById('print-receipt').onclick = function() {
                window.open(`/pos/receipt/${data.transaction_id}`, '_blank');
            };
            
            // Clear cart and reset
            cart = [];
            updateCartDisplay();
            document.getElementById('payment-amount').value = '';
            
            // Auto-focus back to barcode for next transaction
            setTimeout(() => {
                document.getElementById('barcode-input').focus();
            }, 500);
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
        
        // Reset button
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-money-bill me-2"></i>Proses Pembayaran';
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Terjadi kesalahan saat memproses transaksi!', 'error');
        
        // Reset button
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-money-bill me-2"></i>Proses Pembayaran';
    });
});

// Real cashier keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // F1 - Focus barcode input
    if (e.key === 'F1') {
        e.preventDefault();
        document.getElementById('barcode-input').focus();
    }
    
    // F2 - Focus payment amount
    if (e.key === 'F2') {
        e.preventDefault();
        document.getElementById('payment-amount').focus();
    }
    
    // F9 - Clear cart
    if (e.key === 'F9') {
        e.preventDefault();
        if (cart.length > 0 && confirm('Kosongkan keranjang?')) {
            cart = [];
            updateCartDisplay();
            showNotification('Keranjang dikosongkan', 'info');
        }
    }
    
    // Enter on payment amount - process sale
    if (e.key === 'Enter' && e.target.id === 'payment-amount') {
        e.preventDefault();
        const processBtn = document.getElementById('process-sale');
        if (!processBtn.disabled) {
            processBtn.click();
        }
    }
});

function formatCurrency(amount) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
    }).format(amount);
}

// Quick payment functions (real cashier feature)
function quickPay(amount) {
    document.getElementById('payment-amount').value = amount;
    updateTotals();
}

function exactPay() {
    const total = cart.reduce((sum, item) => sum + (item.harga_jual * item.quantity), 0);
    document.getElementById('payment-amount').value = total;
    updateTotals();
}

// Initialize
updateCartDisplay();

// Auto-refresh cart display every 30 seconds (like real POS)
setInterval(() => {
    if (cart.length > 0) {
        updateReceiptPreview();
    }
}, 30000);
</script>
{% endblock %}
